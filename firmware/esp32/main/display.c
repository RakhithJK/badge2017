#include <string.h>
#include "freertos/FreeRTOS.h"
#include "esp_wifi.h"
#include "esp_system.h"
#include "esp_event.h"
#include "esp_event_loop.h"
#include "esp_log.h"
#include "nvs_flash.h"
#include "driver/gpio.h"
#include "driver/spi_master.h"
#include "u8g2.h"
#include "board.h"

#define LCD_DMA_CHAN 1

static const char* tag = "display";

const unsigned char cpvLogo[] =
{
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3F, 0x00, 0x00, 0x00,
    0xE0, 0xFF, 0xE3, 0xFF, 0xF1, 0x0F, 0xFF, 0xFF, 0x1F, 0xFE, 0xFF, 0xE0, 0xFF, 0x00, 0xFF, 0x03,
    0xF0, 0xFF, 0xE7, 0xFF, 0xE7, 0x9F, 0xFF, 0xFF, 0x3F, 0xFE, 0xFF, 0xF8, 0xFF, 0x03, 0xFF, 0x03,
    0xF8, 0xFF, 0xE7, 0xFF, 0xEF, 0x9F, 0x7F, 0xFF, 0x7F, 0xFE, 0xFF, 0xFC, 0xFF, 0x07, 0x03, 0x03,
    0xFC, 0xFF, 0xE3, 0xFF, 0xDF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFE, 0xFF, 0xFE, 0xFF, 0x0F, 0x03, 0x03,
    0xFE, 0xFF, 0xE3, 0xFF, 0xDF, 0xFF, 0x3F, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x03,
    0xFE, 0xFF, 0xE1, 0xFF, 0xBF, 0xFF, 0x1F, 0x7F, 0xFF, 0xE1, 0x0F, 0xFF, 0xFF, 0xFF, 0x03, 0x03,
    0xFE, 0xC3, 0xE1, 0xCF, 0xBF, 0xFF, 0x1F, 0x7F, 0xFE, 0xE1, 0x0F, 0xFF, 0xF0, 0xFF, 0x03, 0x7F,
    0xFF, 0x00, 0xE0, 0x8F, 0x3F, 0xFF, 0x0F, 0x7F, 0xFC, 0xE1, 0x8F, 0x7F, 0xC0, 0xFF, 0x03, 0x7F,
    0xFF, 0x00, 0xE0, 0x8F, 0x3F, 0xFF, 0x0F, 0x7F, 0xFC, 0xE1, 0x8F, 0x3F, 0xC0, 0x1F, 0x00, 0x60,
    0x7F, 0x00, 0xE0, 0xCF, 0x3F, 0xFE, 0x07, 0x7F, 0xFE, 0xE1, 0x8F, 0x3F, 0x80, 0x1F, 0x00, 0x60,
    0x7F, 0x00, 0xE0, 0xFF, 0x3F, 0xFC, 0x03, 0xFF, 0xFF, 0xE1, 0x8F, 0x3F, 0x80, 0x1F, 0x00, 0x60,
    0x7F, 0x00, 0xE0, 0xFF, 0x1F, 0xFC, 0x03, 0xFF, 0xFF, 0xE0, 0x8F, 0x3F, 0x80, 0x1F, 0x00, 0x60,
    0xFF, 0x00, 0xE0, 0xFF, 0x1F, 0xFC, 0x01, 0xFF, 0xFF, 0xE0, 0x8F, 0x3F, 0xC0, 0x1F, 0x00, 0x60,
    0xFF, 0x01, 0xE0, 0xFF, 0x0F, 0xFC, 0x01, 0xFF, 0x7F, 0xE0, 0x8F, 0x7F, 0xC0, 0xFF, 0x03, 0x7F,
    0xFE, 0x83, 0xE1, 0xFF, 0x07, 0xFC, 0x01, 0xFF, 0x3F, 0xE0, 0x0F, 0xFF, 0xF0, 0xFF, 0x03, 0x7F,
    0xFE, 0xFF, 0xE3, 0xFF, 0x0F, 0xFC, 0x01, 0xFF, 0x0F, 0xE0, 0x0F, 0xFF, 0xFF, 0x1F, 0x03, 0x03,
    0xFE, 0xFF, 0xE3, 0xFF, 0x0F, 0xFC, 0x01, 0x7F, 0x00, 0xE0, 0x0F, 0xFE, 0xFF, 0x0F, 0x03, 0x03,
    0xFC, 0xFF, 0xE7, 0xFF, 0x1F, 0xFC, 0x01, 0x7F, 0x00, 0xE0, 0x0F, 0xFE, 0xFF, 0x0F, 0x03, 0x03,
    0xF8, 0xFF, 0xEF, 0xEF, 0x3F, 0xFC, 0x01, 0x7F, 0x00, 0xE0, 0x0F, 0xFC, 0xFF, 0x07, 0x03, 0x03,
    0xF0, 0xFF, 0xEF, 0xCF, 0x3F, 0xFC, 0x01, 0x7F, 0x00, 0xE0, 0x0F, 0xF8, 0xFF, 0x03, 0xFF, 0x03,
    0xE0, 0xFF, 0xE7, 0xCF, 0x7F, 0xFC, 0x01, 0x7F, 0x00, 0xE0, 0x0F, 0xE0, 0xFF, 0x00, 0xFF, 0x03,
    0xC0, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x7F, 0x00, 0x00, 0x00,
    0xFC, 0x7F, 0xE0, 0xFF, 0x03, 0xFF, 0xFF, 0x80, 0x7F, 0xFE, 0x00, 0xF8, 0xFF, 0xFE, 0x81, 0x3F,
    0xFC, 0xFF, 0xE1, 0xFF, 0x07, 0xFF, 0xFF, 0xC0, 0x7F, 0xFE, 0x00, 0xFC, 0xFF, 0xFD, 0xE3, 0x1F,
    0xFC, 0xFF, 0xE3, 0xFF, 0x1F, 0xFF, 0xFF, 0xC1, 0x3F, 0xFF, 0x00, 0xFE, 0xFF, 0xFD, 0xF7, 0x1F,
    0xFC, 0xFF, 0xE7, 0xFF, 0x1F, 0xFF, 0xFE, 0xC1, 0x3F, 0xFF, 0x01, 0xFF, 0xFF, 0xF9, 0xF7, 0x0F,
    0xFC, 0xFF, 0xE7, 0xFF, 0x3F, 0xFF, 0xFE, 0xE1, 0x1F, 0xFF, 0x81, 0xFF, 0xFF, 0xF8, 0xFF, 0x0F,
    0xFC, 0xFF, 0xE7, 0xFF, 0x3F, 0xFF, 0xFC, 0xE3, 0x9F, 0xFF, 0x81, 0xFF, 0xFF, 0xF0, 0xFF, 0x07,
    0xFC, 0xF9, 0xEF, 0xCF, 0x7F, 0xFF, 0xFC, 0xF3, 0x9F, 0xFF, 0xC3, 0xFF, 0x79, 0xF0, 0xFF, 0x07,
    0xFC, 0xF1, 0xEF, 0x8F, 0x7F, 0xFF, 0xFC, 0xF7, 0xCF, 0xFF, 0xC3, 0x7F, 0x00, 0xE0, 0xFF, 0x03,
    0xFC, 0xF1, 0xEF, 0x8F, 0x7F, 0xFF, 0xF8, 0xF7, 0xCF, 0xFF, 0xC7, 0x3F, 0x00, 0xE0, 0xFF, 0x03,
    0xFC, 0xF1, 0xEF, 0x8F, 0x7F, 0xFF, 0xF8, 0xFF, 0xC7, 0xFF, 0xE7, 0x1F, 0x00, 0xC0, 0xFF, 0x01,
    0xFC, 0xF9, 0xEF, 0xCF, 0x7F, 0xFF, 0xF8, 0xFF, 0xE7, 0xFF, 0xE7, 0x1F, 0x00, 0x80, 0xFF, 0x01,
    0xFC, 0xFF, 0xE7, 0xFF, 0x3F, 0xFF, 0xF0, 0xFF, 0xE7, 0xFF, 0xEF, 0x1F, 0x00, 0x80, 0xFF, 0x00,
    0xFC, 0xFF, 0xE7, 0xFF, 0x3F, 0xFF, 0xF0, 0xFF, 0xE3, 0xEF, 0xEF, 0x1F, 0x00, 0x00, 0x7F, 0x00,
    0xFC, 0xFF, 0xE3, 0xFF, 0x1F, 0xFF, 0xE0, 0xFF, 0xF3, 0xEF, 0xCF, 0x3F, 0x00, 0x00, 0x7F, 0x00,
    0xFC, 0xFF, 0xE3, 0xFF, 0x1F, 0xFF, 0xE0, 0xFF, 0xF3, 0xE7, 0xDF, 0x7F, 0x00, 0x00, 0x7F, 0x00,
    0xFC, 0xFF, 0xE0, 0xFF, 0x0F, 0xFF, 0xE0, 0xFF, 0xF9, 0xFF, 0xDF, 0xFF, 0xF0, 0x00, 0x7F, 0x00,
    0xFC, 0x3F, 0xE0, 0xFF, 0x1F, 0xFF, 0xC0, 0xFF, 0xF9, 0xFF, 0xDF, 0xFF, 0xFF, 0x00, 0x7F, 0x00,
    0xFC, 0x01, 0xE0, 0xFF, 0x1F, 0xFF, 0xC0, 0xFF, 0xF8, 0xFF, 0xBF, 0xFF, 0xFF, 0x01, 0x7F, 0x00,
    0xFC, 0x01, 0xE0, 0xEF, 0x3F, 0xFF, 0x80, 0xFF, 0xFC, 0xFF, 0x3F, 0xFF, 0xFF, 0x01, 0x7F, 0x00,
    0xFC, 0x01, 0xE0, 0xEF, 0x3F, 0xFF, 0x80, 0xFF, 0xFC, 0xFF, 0x7F, 0xFF, 0xFF, 0x03, 0x7F, 0x00,
    0xFC, 0x01, 0xE0, 0xCF, 0x7F, 0xFF, 0x80, 0x7F, 0xFC, 0xFF, 0x7F, 0xFC, 0xFF, 0x03, 0x7F, 0x00,
    0xFC, 0x01, 0xE0, 0x8F, 0x7F, 0xFF, 0x00, 0x7F, 0xFE, 0x01, 0xFF, 0xF8, 0xFF, 0x01, 0x7F, 0x00,
    0xFC, 0x01, 0xE0, 0x8F, 0x7F, 0xFF, 0x00, 0x3F, 0xFE, 0x00, 0xFE, 0xE0, 0x7F, 0x00, 0x7F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

//unsigned char lcdBuf[1024];

spi_device_handle_t lcd_spi;
u8g2_t u8g2;

spi_bus_config_t lcd_SPI_master_cfg = {
	.miso_io_num = -1,
	.mosi_io_num = PIN_LCD_MOSI,
	.sclk_io_num = PIN_LCD_SCK,
	.quadwp_io_num = -1,
	.quadhd_io_num = -1
};

void lcd_spi_pre_transfer_callback(spi_transaction_t *t) {
    gpio_set_level(PIN_LCD_DC, (int)t->user);
}

spi_device_interface_config_t lcd_SPI_dev_cfg = {
	.clock_speed_hz = 1000000,					// Clock out at 10 MHz
	.mode = 0,									// SPI mode 0
	.spics_io_num = PIN_LCD_CS,					// CS pin
	.queue_size = 7,							// We want to be able to queue 7 transactions at a time
	.pre_cb = lcd_spi_pre_transfer_callback,	// Specify pre-transfer callback to handle D/C line
};

void lcd_cmd_array(const uint8_t *cmds, int len) {
	spi_transaction_t t;
	memset(&t, 0, sizeof(t));
	t.length = len * 8;
	t.tx_buffer = cmds;
	t.user = (void *)0;
	ESP_ERROR_CHECK(spi_device_transmit(lcd_spi, &t));
}

void lcd_cmd(const uint8_t cmd) {
/*	spi_transaction_t t;
	memset(&t, 0, sizeof(t));
	t.length = 8;
	t.tx_buffer = &cmd;
	t.user = (void *)0;
	ESP_ERROR_CHECK(spi_device_transmit(lcd_spi, &t));
*/
	lcd_cmd_array(&cmd, 1);
}

void lcd_data(const uint8_t *data, int len) {
	spi_transaction_t t;
	memset(&t, 0, sizeof(t));
	t.length = len * 8;
	t.tx_buffer = data;
	t.user = (void *)1;
	ESP_ERROR_CHECK(spi_device_transmit(lcd_spi, &t));
}

uint8_t u8x8_esp_msg_cb(u8x8_t *u8x8, uint8_t msg, uint8_t arg_int, void *arg_ptr) {
	static uint8_t dc = 0;
	spi_transaction_t t;

	switch (msg) {
	case U8X8_MSG_BYTE_INIT:
		// TODO(supersat): Move SPI / GPIO initialization here
		return 1;
	case U8X8_MSG_BYTE_SET_DC:
		dc = arg_int;
		return 1;
	case U8X8_MSG_BYTE_START_TRANSFER:
	case U8X8_MSG_BYTE_END_TRANSFER:
		return 1;
	case U8X8_MSG_BYTE_SEND:
		memset(&t, 0, sizeof(t));
		t.length = arg_int * 8;
		t.tx_buffer = arg_ptr;
		t.user = (void *)dc;
		ESP_ERROR_CHECK(spi_device_transmit(lcd_spi, &t));
		return 1;
	default:
		ESP_LOGD(tag, "UNKNOWN U8X8 MSG BYTE CALLBACK %08x", msg);
	}

	return 0;
}

uint8_t u8x8_esp_gpio_and_delay(u8x8_t *u8x8, uint8_t msg, uint8_t arg_int, void *arg_ptr)
{
	switch (msg) {
	case U8X8_MSG_GPIO_AND_DELAY_INIT:
		return 1;
	case U8X8_MSG_GPIO_RESET:
		gpio_set_level(PIN_LCD_RESET, arg_int);
		return 1;
	case U8X8_MSG_DELAY_MILLI:
		vTaskDelay(arg_int / portTICK_PERIOD_MS);
		return 1;
	default:
		ESP_LOGD(tag, "UNKNOWN U8X8 GPIO AND DELAY MSG %08x", msg);
	}

	return 0;
}

/*
void display_test() {
	uint8_t cmdBuf[4];
	uint8_t dataBuf[128];
	cmdBuf[0] = 0;
	cmdBuf[1] = 0x10;
	for (int page = 0; page < 8; page++) {
		cmdBuf[2] = 0xb0 | page;
		lcd_cmd_array(cmdBuf, 3);
		memcpy(dataBuf, cpvLogo + page * 128, 128);
		lcd_data(dataBuf, 128);
	}
}
*/


static uint8_t WarningBits_bits[] = {
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x00,0x00,0x00,0x10,0x01,
 0x00,0x00,0x08,0x07,0x00,0x00,0x08,0x0e,0x00,0x00,0x04,0x0e,0x00,0x00,0x04,
 0x1c,0x00,0x00,0x02,0x1c,0x00,0x00,0xe2,0x38,0x00,0x00,0xf1,0x39,0x00,0x00,
 0xf1,0x71,0x00,0x80,0xf0,0x71,0x00,0x80,0xf0,0xe1,0x00,0x40,0xf0,0xe1,0x00,
 0x40,0xf0,0xc1,0x01,0x20,0xf0,0xc1,0x01,0x20,0xf0,0x81,0x03,0x10,0xe0,0x80,
 0x03,0x10,0xe0,0x00,0x07,0x08,0xe0,0x00,0x07,0x08,0xe0,0x00,0x0e,0x04,0x00,
 0x00,0x0e,0x04,0xe0,0x00,0x1c,0x02,0xf0,0x01,0x1c,0x02,0xf0,0x01,0x38,0x01,
 0xe0,0x00,0x38,0x01,0x00,0x00,0x70,0x01,0x00,0x00,0x70,0xff,0xff,0xff,0x7f,
 0xf8,0xff,0xff,0x3f,0x00,0x00,0x00,0x00};

static void update_countdown_task(void *pvParameter) {
	time_t curTime;
	int timeLeft, days, hours, minutes;
	char buf[16];

	for (;;) {
		curTime = time(NULL);
		if (curTime > 1483228800) {
			//timeLeft = 1501174800 - curTime;
			timeLeft = 1501261200 - curTime;
			days = timeLeft / 86400;
			timeLeft -= days * 86400;
			hours = timeLeft / 3600;
			timeLeft -= hours * 3600;
			minutes = timeLeft / 60;
			timeLeft -= minutes * 60;
			snprintf(buf, sizeof(buf), "%02d %02d:%02d:%02d", days, hours, minutes, timeLeft);
			u8g2_SetFont(&u8g2, u8g2_font_freedoomr10_mu);
			u8g2_DrawStr(&u8g2, 48, 64, buf);
			u8g2_SendBuffer(&u8g2);
		}
		vTaskDelay(1000 / portTICK_PERIOD_MS);
	}
}

void display_test() {
	u8g2_InitDisplay(&u8g2);
	u8g2_ClearDisplay(&u8g2);
	u8g2_SetPowerSave(&u8g2, 0);
	u8g2_ClearBuffer(&u8g2);
	u8g2_SetFont(&u8g2, u8g2_font_profont12_mr);
	u8g2_DrawXBM(&u8g2, 0, 16, 32, 32, WarningBits_bits);
	u8g2_DrawStr(&u8g2, 36, 12, "OOPS! All your");
	u8g2_DrawStr(&u8g2, 36, 24, "badges have");
	u8g2_DrawStr(&u8g2, 36, 36, "been encrypted!");
	u8g2_SendBuffer(&u8g2);
	xTaskCreate(&update_countdown_task, "update_countdown_task", 2048, NULL, 5, NULL);
}

void display_show_logo() {
	u8g2_InitDisplay(&u8g2);
	u8g2_ClearDisplay(&u8g2);
	u8g2_SetPowerSave(&u8g2, 0);
	u8g2_DrawXBM(&u8g2, 0, 0, 128, 64, cpvLogo);
	u8g2_SendBuffer(&u8g2);
}

void display_on() {
	lcd_cmd(0xA4);
	lcd_cmd(0xAF);
}

void display_off() {
	lcd_cmd(0xAE); // display off
	lcd_cmd(0xA5); // display all points
}

// Called whenever we need to re-enable the LCD
void display_enable() {
	gpio_set_level(PIN_LCD_RESET, 1);
	vTaskDelay(1 / portTICK_PERIOD_MS); // sleep for 1 ms
	gpio_set_level(PIN_LCD_RESET, 0);
	vTaskDelay(1 / portTICK_PERIOD_MS); // sleep for 1 ms
	gpio_set_level(PIN_LCD_RESET, 1);
	vTaskDelay(1 / portTICK_PERIOD_MS); // sleep for 1 ms
	lcd_cmd(0xa0); // Clear ADC (normal SEG order)
	lcd_cmd(0xc8); // Set COM order
	lcd_cmd(0xa2); // Clear bias
	lcd_cmd(0x2f); // Use internal voltage booster, regulator, and follower
	lcd_cmd(0x25); // Regulator resistor selector
	lcd_cmd(0xa7);
}

void display_disable() {
	display_off();
	gpio_set_level(PIN_LCD_RESET, 0);
}

// Called ONCE per boot
void display_init() {
	gpio_set_direction(PIN_LCD_RESET, GPIO_MODE_OUTPUT);
	gpio_set_direction(PIN_LCD_DC, GPIO_MODE_OUTPUT);
	ESP_ERROR_CHECK(spi_bus_initialize(VSPI_HOST, &lcd_SPI_master_cfg, LCD_DMA_CHAN));
	ESP_ERROR_CHECK(spi_bus_add_device(VSPI_HOST, &lcd_SPI_dev_cfg, &lcd_spi));
	u8g2_Setup_st7565_erc12864_f(&u8g2, U8G2_R0, u8x8_esp_msg_cb, u8x8_esp_gpio_and_delay);
	u8g2_InitDisplay(&u8g2);
	u8g2_ClearDisplay(&u8g2);
}
